# Incident Response Runbook\n\n## Overview\n\nThis runbook provides step-by-step procedures for responding to incidents related to the BrightCloud Container Registry platform.\n\n## Incident Classification\n\n### Severity Levels\n\n#### P1 - Critical (Response: Immediate)\n- Complete service outage\n- Data loss or corruption\n- Security breach or unauthorized access\n- SLA breach affecting production workloads\n\n#### P2 - High (Response: 1 hour)\n- Significant performance degradation\n- Feature unavailability affecting multiple teams\n- Failed deployments blocking releases\n\n#### P3 - Medium (Response: 4 hours)\n- Minor feature issues\n- Performance degradation not affecting SLA\n- Documentation or tooling issues\n\n#### P4 - Low (Response: Next business day)\n- Feature requests\n- Non-urgent improvements\n- Enhancement suggestions\n\n## Common Incident Scenarios\n\n### 1. Registry Login Failures\n\n#### Symptoms\n- `az acr login` commands failing\n- Docker authentication errors\n- 401/403 HTTP responses\n\n#### Immediate Actions\n1. **Verify Service Health**\n   ```bash\n   az acr check-health --name <registry-name>\n   ```\n\n2. **Check Registry Status**\n   ```bash\n   az acr show --name <registry-name> --query '{name:name, status:status, adminUserEnabled:adminUserEnabled}'\n   ```\n\n3. **Verify Network Connectivity**\n   ```bash\n   # Test public endpoint (if enabled)\n   nslookup <registry-name>.azurecr.io\n   \n   # Test private endpoint\n   nslookup <registry-name>.privatelink.azurecr.io\n   ```\n\n#### Root Cause Investigation\n1. **Check Azure Service Health**\n   - Navigate to Azure Portal > Service Health\n   - Filter by Container Registry and region\n\n2. **Review Authentication Configuration**\n   ```bash\n   # Check RBAC assignments\n   az role assignment list --scope /subscriptions/<subscription-id>/resourceGroups/<rg-name>/providers/Microsoft.ContainerRegistry/registries/<registry-name>\n   \n   # Check scope maps and tokens\n   az acr scope-map list --registry <registry-name>\n   az acr token list --registry <registry-name>\n   ```\n\n3. **Verify Network Configuration**\n   ```bash\n   # Check network rules\n   az acr network-rule list --name <registry-name>\n   \n   # Check private endpoint status\n   az network private-endpoint list --resource-group <rg-name>\n   ```\n\n#### Resolution Steps\n1. **For RBAC Issues**:\n   - Re-assign appropriate roles\n   - Regenerate tokens if necessary\n   - Verify team membership in Azure AD groups\n\n2. **For Network Issues**:\n   - Update network rules if IP ranges changed\n   - Verify private endpoint DNS resolution\n   - Check NSG rules on subnets\n\n3. **For Service Issues**:\n   - Engage Microsoft Azure Support\n   - Monitor Azure Service Health dashboard\n\n### 2. Image Push/Pull Failures\n\n#### Symptoms\n- Docker push/pull commands timing out\n- Image corruption or missing layers\n- Quota exceeded errors\n\n#### Immediate Actions\n1. **Check Registry Quotas**\n   ```bash\n   az acr show-usage --name <registry-name>\n   ```\n\n2. **Verify Image Repository Permissions**\n   ```bash\n   # Test with a simple image\n   docker pull hello-world\n   docker tag hello-world <registry-name>.azurecr.io/test/hello-world:latest\n   docker push <registry-name>.azurecr.io/test/hello-world:latest\n   ```\n\n3. **Check for Quarantine Policy Issues**\n   ```bash\n   az acr repository show --name <registry-name> --repository <repository-name>\n   ```\n\n#### Resolution Steps\n1. **For Quota Issues**:\n   - Clean up unused images\n   - Increase registry tier if necessary\n   - Implement retention policies\n\n2. **For Permission Issues**:\n   - Verify repository naming follows team/environment pattern\n   - Check scope map configurations\n   - Validate Azure AD group memberships\n\n3. **For Quarantine Issues**:\n   - Review vulnerability scan results\n   - Whitelist images if false positives\n   - Update base images to resolve vulnerabilities\n\n### 3. Performance Degradation\n\n#### Symptoms\n- Slow image pushes/pulls\n- Increased response times\n- Timeout errors\n\n#### Investigation Steps\n1. **Review Metrics**\n   ```bash\n   # Get registry metrics\n   az monitor metrics list --resource /subscriptions/<sub-id>/resourceGroups/<rg-name>/providers/Microsoft.ContainerRegistry/registries/<registry-name> --metric \"PullCount,PushCount,StorageUsed\"\n   ```\n\n2. **Check Regional Load**\n   - Review geo-replication metrics\n   - Check traffic distribution\n\n3. **Analyze Network Path**\n   - Test from different locations\n   - Verify CDN/edge cache status\n\n#### Resolution Steps\n1. **Scale Up Registry**:\n   - Consider upgrading SKU\n   - Add geo-replication regions\n\n2. **Optimize Images**:\n   - Review layer structure\n   - Implement multi-stage builds\n   - Use base image caching\n\n3. **Network Optimization**:\n   - Optimize private endpoint configuration\n   - Review DNS resolution performance\n\n## Security Incident Response\n\n### Unauthorized Access Detection\n\n#### Immediate Actions\n1. **Isolate the Registry**\n   ```bash\n   # Disable public access\n   az acr update --name <registry-name> --public-network-enabled false\n   \n   # Review and restrict IP rules\n   az acr network-rule update --name <registry-name> --default-action Deny\n   ```\n\n2. **Audit Access Logs**\n   ```bash\n   # Query activity logs\n   az monitor activity-log list --resource-group <rg-name> --start-time <start-time> --end-time <end-time>\n   ```\n\n3. **Revoke Compromised Credentials**\n   ```bash\n   # Regenerate admin password (if used)\n   az acr credential renew --name <registry-name> --password-name password\n   \n   # Revoke tokens\n   az acr token delete --name <token-name> --registry <registry-name>\n   ```\n\n#### Investigation Process\n1. **Identify Attack Vector**\n   - Review access patterns\n   - Check for unusual geographic access\n   - Analyze authentication methods used\n\n2. **Assess Impact**\n   - Inventory accessed repositories\n   - Check for unauthorized images\n   - Verify image integrity\n\n3. **Containment**\n   - Reset all credentials\n   - Update access policies\n   - Implement additional monitoring\n\n## Communication Templates\n\n### Incident Declaration Email\n```\nSubject: [P1] BrightCloud ACR Incident - <Brief Description>\n\nIncident Details:\n- Incident ID: INC-<timestamp>\n- Severity: P1\n- Status: Investigating\n- Affected Service: BrightCloud Container Registry\n- Impact: <Description of impact>\n- Start Time: <UTC timestamp>\n\nActions Taken:\n- <List immediate actions>\n\nNext Steps:\n- <List planned actions>\n\nIncident Commander: <Name>\nCommunication Lead: <Name>\n\nNext update in 30 minutes.\n```\n\n### Resolution Communication\n```\nSubject: [RESOLVED] BrightCloud ACR Incident - <Brief Description>\n\nIncident Resolution:\n- Incident ID: INC-<timestamp>\n- Status: Resolved\n- Resolution Time: <UTC timestamp>\n- Duration: <Duration>\n\nRoot Cause:\n<Brief explanation>\n\nResolution:\n<Actions taken to resolve>\n\nFollow-up Actions:\n- <List any follow-up items>\n- <Post-incident review scheduled>\n\nThank you for your patience during this incident.\n```\n\n## Contact Information\n\n### Escalation Matrix\n- **L1 Support**: Platform Team (24/7)\n- **L2 Support**: Senior Platform Engineers\n- **L3 Support**: Azure Container Registry Product Team\n- **Security Team**: security@brightcloud.example.com\n- **Platform Lead**: platform-lead@brightcloud.example.com\n\n### External Contacts\n- **Microsoft Azure Support**: [Support Portal](https://portal.azure.com)\n- **Azure Status Page**: https://status.azure.com\n\n## Post-Incident Actions\n\n1. **Post-Incident Review (PIR)**\n   - Schedule within 5 business days\n   - Include all stakeholders\n   - Document lessons learned\n\n2. **Action Items**\n   - Create improvement tasks\n   - Assign owners and due dates\n   - Track to completion\n\n3. **Documentation Updates**\n   - Update runbooks based on findings\n   - Improve monitoring and alerting\n   - Enhance preventive measures\n\n## Monitoring and Alerting\n\n### Key Metrics to Monitor\n- Registry availability\n- Authentication success rate\n- Push/pull performance\n- Storage utilization\n- Network connectivity\n\n### Alert Thresholds\n- Availability < 99.9%\n- Authentication failure rate > 5%\n- Average response time > 2 seconds\n- Storage utilization > 80%\n\n## Tools and Resources\n\n### Required Tools\n- Azure CLI\n- Docker CLI\n- kubectl (for AKS integration)\n- jq (for JSON processing)\n\n### Useful Commands Reference\n```bash\n# Registry health check\naz acr check-health --name <registry-name>\n\n# List repositories\naz acr repository list --name <registry-name>\n\n# Show repository details\naz acr repository show --name <registry-name> --repository <repo-name>\n\n# List tags\naz acr repository show-tags --name <registry-name> --repository <repo-name>\n\n# Check replication status\naz acr replication list --registry <registry-name>\n\n# Monitor build status\naz acr task list-runs --registry <registry-name>\n```"